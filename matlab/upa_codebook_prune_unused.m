clear *

%obtain histograms via
%D:\github\5gm-data>python getBestBeamsFromChannelRays.py > hists.txt
%tx_indices_histogram = [ 0 0 0 0 0 0 35 23 0 0 0 0 0 0 0 0 0 0 37 24 6 0 0 0 0 0 0 0 0 2 24 23 9 0 0 0 0 0 0 0 0 24 0 109 16 1 0 0 0 0 0 0 0 0 0 41 105 12 0 0 0 0 0 0 0 0 0 0 45 213 70 0 1900 132 554 0 0 0 0 0 0 0 990 2468 0 0 0 36 35 0 0 0 149 764 150 0 0 0 0 0 44 10 0 44 200 18 0 0 0 0 0 0 0 10 0 108 21 0 0 0 0 0 0 0 0 0 20 30 15 0 0 0 0 0 0 0 0 0 40 20 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ];
%rx_indices_histogram = [ 0 0 0 0 0 23 41 0 0 0 0 0 0 0 0 0 0 20 50 0 0 0 0 0 0 0 0 0 15 27 19 1 0 0 0 0 0 0 0 0 21 78 0 28 0 0 0 0 0 0 0 18 140 47 0 29 47 0 0 0 0 1 85 290 42 0 0 0 84 294 62 0 1525 3146 683 1 0 0 0 0 0 1 503 138 0 0 61 176 23 0 0 0 114 255 8 0 0 0 0 12 68 15 0 20 49 0 0 0 0 0 0 0 17 56 0 85 0 0 0 0 0 0 0 0 9 20 60 9 0 0 0 0 0 0 0 0 6 24 31 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ];
%tx_indices_histogram =[0     0     0     0     0     0     0     0     5     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0  1023     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0    11     0     0     0     0     0     0     0     0     0     0     0     0     0     0  1008     0  1478     0     0     0     0     0     0     0     0     0     0     0     0     0  1159     0    30     0     0     0     0     0     0     0     0     0     0     0     0  1337     0     0     1    16     0     0     0     0     0     0     0     0     0     0     5     0     0     0     0     4     6     0     0     0     0     0  1149  1431     4  1425     0     0     0     0     0     0     0     8     3     1     1     3     8     2     0     0     0     0     0     0     0     0     0     0     0     6     3     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     2     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0    10     0     0     0     0     0     0     6     0     0     0     0     0     0     0     0     0     3     0     0     0     0     0    14     0     0     0     0     0     0     0     0     0     2     7     0     0     0     0     9     0     0     0     0     0     0     0     0     0     0     4    14     0     0     0    30     0     0     0     0     0     0     0     0     0     0     0     0    14     0     0    34     0     0     0     0     0     0     0     0     0     0     0     0     0    31     0     2     0     0     0     0     0     0     0     0     0     0     0     0     0     1    40     4     0     0     0     0     0     0     0     0     0     0     0     0     0     0     4    20     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     3     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     3     0     0     0     0     1     0     0     0     0     0     0     0     0     0   796     0     0     0     0     0     0     0     0     0     0     0     0     0     0   976     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0];
%rx_indices_histogram =[0     0     0     0     0     0     0     0     9     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     3     0  1008     0     0     0     0     0     0     0     0     0     0     0     0     0  1151     0     2     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1  1330     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0  1421     0     0     0     3     3     6     0     0     0     0     0     0     0     0     0     0     0     2     8     0     1     1     3     8     0     0     0     0     0     0     0     4     5  1431  1149     0     0     0     0     0     6     4     0     0     0     0     5     0     0     0     0     0     0     0     0     0     0    11     0     0     1    10     0     0     0     0     0     0     0     0     0     0     0     0    19     0    12     0     0     0     0     0     0     0     0     0     0     0     0     0     7     0  1015     0     0     0     0     0     0     0     0     0     0     0     0     0     0    10     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0    22     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     6     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0  1455     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     3     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     3     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0    27     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0    46     0     0     0     0     0     0     0     0     0     0     0     0     1     6     0    23     0     0     0     0     0     0     0     0     0     0     0     0    31     0     0   804     0     0     0     0     0     0     0     0     0     0     2    25     2     0     0   985     0     0     0     0     0     0     0     0     0     3    11     2     0     0     0     7     0     0     0     0     0     0     0     0     1    15     1     0     0     0     0     1     0     0     0     0     0     0     0     0    19     0     0     0     0     0     0     2     0     0     0     0     0     0     0     0];
tx_indices_histogram = [ 0 0 0 0 0 0 0 0 82 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 403 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 336 0 0 0 0 0 0 0 0 0 0 0 0 0 0 190 1 591 0 0 0 0 0 0 0 0 0 0 0 0 2 396 0 788 1 0 0 0 0 0 0 0 0 0 0 2 283 37 0 67 455 2 0 0 0 0 0 0 0 1 3 168 55 0 0 0 95 228 3 0 0 0 0 1 12 83 98 10 0 0 0 0 0 5 126 84 7 0 70 91 63 12 0 0 0 0 0 0 0 0 0 7 78 87 0 0 0 16 15 0 0 0 0 0 0 0 8 3 0 0 0 0 0 0 0 0 0 0 0 0 16 25 0 0 0 0 0 0 0 0 0 0 0 0 0 19 93 0 0 0 0 0 0 0 0 0 0 0 0 0 0 17 0 0 0 0 0 0 0 0 0 0 0 0 0 7 0 9 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 10 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 230 3 0 0 0 0 0 216 0 0 0 0 0 0 0 55 4 201 2 0 0 0 0 381 0 0 0 0 0 1 0 13 0 21 132 5 1 0 0 218 0 0 0 0 1 56 0 0 0 0 13 157 7 0 0 612 0 0 0 0 79 18 0 0 0 0 0 13 369 6 0 777 0 0 0 0 17 0 0 0 0 0 0 0 1 436 23 40 0 0 0 0 0 0 0 0 0 0 0 0 1 132 589 202 0 0 0 0 0 0 0 0 0 0 0 0 0 2 209 175 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3 72 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 10 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 14 0 0 0 0 0 0 0 0 0 0 30 0 0 0 0 0 0 0 0 0 0 9 0 0 1 142 2 0 0 0 0 2 0 0 0 0 0 1 0 0 169 5 0 0 0 0 0 0 0 0 0 0 0 0 0 43 ];
rx_indices_histogram = [ 0 0 758 0 0 9 528 26 318 454 0 428 0 217 1271 168 52 5 88 92 0 0 0 0 3 2 0 0 0 0 0 0 0 0 0 0 252 148 0 84 1 177 0 1 7 3806 0 3 944 1029 0 323 ];

%now only NLOS statistics:
%tx_indices_histogram = [ 0 0 0 0 0 0 21 0 0 0 0 0 0 0 0 0 0 0 20 1 0 0 0 0 0 0 0 0 0 1 20 4 0 0 0 0 0 0 0 0 0 21 0 91 0 0 0 0 0 0 0 0 0 0 0 39 41 0 0 0 0 0 4 0 0 0 0 0 30 102 19 0 822 113 532 0 0 0 0 0 0 0 635 774 0 0 0 36 30 0 0 0 131 583 90 0 0 0 0 0 38 6 0 39 135 0 0 0 0 0 0 0 0 10 0 65 0 0 0 0 0 0 0 0 0 0 27 3 0 0 0 0 0 0 0 0 0 0 24 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 5 8 56 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ];
%rx_indices_histogram = [ 4578 ];

%define input / output files
inputFileNameTx = 'upa_codebook_16x16_N832';
outputFileNameTx = ['tx_' inputFileNameTx '_valid.mat'];

inputFileNameRx = 'upa_codebook_4x4_N52';
outputFileNameRx = ['rx_' inputFileNameRx '_valid.mat'];

%% Process Tx
load([inputFileNameTx '.mat'])
%recall we used:
%save(outputFileName,'W','codebook','Wx','Wy','Nax','Nay','-v6')
%and saved redundant information on Wx and Wy, but now will discard

%choose only used indices (or most frequent)
minCountTx=200; %can use 1 for example to eliminate with zero counts
validTx = find(tx_indices_histogram>=minCountTx);
W=W(:,validTx);
codebook = codebook(validTx,:);
%write new dictionaries
save(outputFileNameTx,'W','codebook','Nax','Nay','-v6')
disp(['Wrote ' outputFileNameTx ' with ' num2str(length(validTx)) ' codewords'])

%% Process Rx
load([inputFileNameRx '.mat'])
%recall we used:
%save(outputFileName,'W','codebook','Wx','Wy','Nax','Nay','-v6')
%and saved redundant information on Wx and Wy, but now will discard
minCountRx=200;
%choose only used indices (or most frequent)
validRx = find(rx_indices_histogram>=minCountRx);
W=W(:,validRx);
codebook = codebook(validRx,:);
%write new dictionaries
save(outputFileNameRx,'W','codebook','Nax','Nay','-v6')
disp(['Wrote ' outputFileNameRx ' with ' num2str(length(validRx)) ' codewords'])

%prob of most popular Tx index
p=max(tx_indices_histogram)/sum(tx_indices_histogram);
disp(['prob of most popular Tx index=' num2str(p)])

pr=max(rx_indices_histogram)/sum(rx_indices_histogram);
disp(['prob of most popular Rx index=' num2str(pr)])